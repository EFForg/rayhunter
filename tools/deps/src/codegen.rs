use std::collections::BTreeMap;

use crate::graph::{DepGraph, FeatureData};

impl DepGraph {
    pub fn capability_features(&self) -> BTreeMap<&str, &FeatureData> {
        let all_device_names: Vec<&str> = self.devices.keys().map(|s| s.as_str()).collect();
        let excluded_categories = ["display", "installer", "build", "binary"];

        self.features
            .iter()
            .filter(|(name, feat)| {
                let feat_devices: Vec<&str> = feat.devices.iter().map(|s| s.as_str()).collect();
                if feat_devices.len() == all_device_names.len()
                    && all_device_names.iter().all(|d| feat_devices.contains(d))
                {
                    return false;
                }
                if excluded_categories.contains(&feat.category.as_str()) {
                    return false;
                }
                if all_device_names
                    .iter()
                    .any(|d| name.starts_with(&format!("{d}_")))
                {
                    return false;
                }
                true
            })
            .map(|(name, feat)| (name.as_str(), feat))
            .collect()
    }

    pub fn generate_rust_capabilities(&self) -> String {
        let cap_features = self.capability_features();
        let all_device_names: Vec<&str> = self.devices.keys().map(|s| s.as_str()).collect();

        let mut lines = vec![
            "// @generated by rayhunter-deps generate -- do not edit".to_string(),
            String::new(),
            "use rayhunter::Device;".to_string(),
            String::new(),
            "#[allow(dead_code)]".to_string(),
            "pub struct DeviceCapabilities {".to_string(),
        ];

        for &name in cap_features.keys() {
            lines.push(format!("    pub {name}: bool,"));
        }
        lines.push("}".to_string());
        lines.push(String::new());
        lines.push("pub fn capabilities_for(device: &Device) -> DeviceCapabilities {".to_string());
        lines.push("    match device {".to_string());

        for &device in &all_device_names {
            let variant = &self.devices[device].rust_variant;
            lines.push(format!(
                "        Device::{variant} => DeviceCapabilities {{"
            ));
            for (&name, feat) in &cap_features {
                let val = if feat.devices.contains(&device.to_string()) {
                    "true"
                } else {
                    "false"
                };
                lines.push(format!("            {name}: {val},"));
            }
            lines.push("        },".to_string());
        }

        lines.push("    }".to_string());
        lines.push("}".to_string());
        lines.push(String::new());

        lines.join("\n")
    }
}
